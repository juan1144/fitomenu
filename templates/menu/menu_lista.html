{#{% extends "base.html" %}#}
{#{% block title %}Menú de Productos - FitoMenu{% endblock %}#}
{##}
{#{% block content %}#}
{##}
{#<style>#}
{#  .product-card {#}
{#    width: 250px;#}
{#    height: 350px;#}
{#    display: flex;#}
{#    flex-direction: column;#}
{#    align-items: center;#}
{#    justify-content: space-between;#}
{#    text-align: center;#}
{#}#}
{#.product-card img {#}
{#    width: 100%;#}
{#    height: 200px;#}
{#    object-fit: cover;#}
{#}#}
{#</style>#}
{##}
{#<div class="container">#}
{#  <div class="row justify-content-center">#}
{#    {% for producto in producto %}#}
{#    <div class="col-md-4 mb-4">#}
{#      <div class="card mx-auto product-card" style="width: 18rem">#}
{#        <img class"product-card img" src="{{ producto.imagen.url }}" class="card-img-top" alt="{{ producto.nombre }}" />#}
{#        <div class="card-body">#}
{#          <h5 class="card-title">{{ producto.nombre }}</h5>#}
{#          <p class="card-text"><b>${{ producto.precio }}</b></p>#}
{#          <button class="btn btn-primary" onclick="setProductoId({{ producto.id }})" data-bs-toggle="modal" data-bs-target="#numeroMesaModal">#}
{#            Agregar#}
{#          </button>#}
{#        </div>#}
{#      </div>#}
{#    </div>#}
{#    {% endfor %}#}
{#  </div>#}
{#</div>#}
{##}
{#<!-- Modal para ingresar el número de mesa -->#}
{#<div class="modal fade" id="numeroMesaModal" tabindex="-1" aria-labelledby="numeroMesaLabel" aria-hidden="true">#}
{#  <div class="modal-dialog">#}
{#    <div class="modal-content">#}
{#      <div class="modal-header">#}
{#        <h5 class="modal-title" id="numeroMesaLabel">Ingrese detalles del pedido</h5>#}
{#        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>#}
{#      </div>#}
{#      <div class="modal-body">#}
{#        <label for="numeroMesaInput">Número de mesa:</label>#}
{#        <input type="number" id="numeroMesaInput" class="form-control" placeholder="Número de mesa" min="1">#}
{##}
{#        <label for="cantidadInput" class="mt-2">Cantidad:</label>#}
{#        <input type="number" id="cantidadInput" class="form-control" placeholder="Cantidad" min="1" value="1">#}
{#      </div>#}
{#      <div class="modal-footer">#}
{#        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>#}
{#        <button type="button" class="btn btn-primary" onclick="agregarAlCarrito()">Agregar</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<!-- Contador del carrito -->#}
{#{% comment %} <div id="carrito-contador" style="position: fixed; bottom: 20px; right: 20px; background: red; color: white; padding: 10px 15px; border-radius: 50%; font-size: 1.2rem;">#}
{#  0#}
{#</div> {% endcomment %}#}
{##}
{#<script>#}
{#  let productoId = null;#}
{#  let carrito = new Set(JSON.parse(localStorage.getItem("carrito")) || []); // Cargar carrito desde localStorage#}
{##}
{#  function setProductoId(id) {#}
{#      productoId = id;#}
{#  }#}
{##}
{#  function agregarAlCarrito() {#}
{#      let numeroMesa = document.getElementById("numeroMesaInput").value;#}
{#      let cantidad = document.getElementById("cantidadInput").value;#}
{##}
{#      if (!numeroMesa || !cantidad || cantidad <= 0) {#}
{#          alert("Por favor, ingrese un número de mesa y una cantidad válida.");#}
{#          return;#}
{#      }#}
{##}
{#      fetch(`/menu/carrito/${productoId}/${numeroMesa}/${cantidad}/`, {#}
{#          method: "POST",#}
{#          headers: {#}
{#              "Content-Type": "application/json",#}
{#              "X-CSRFToken": "{{ csrf_token }}"#}
{#          },#}
{#          body: JSON.stringify({})#}
{#      })#}
{#      .then(response => response.json())#}
{#      .then(data => {#}
{#          if (data.success) {#}
{#              alert("Producto agregado al carrito.");#}
{#              #}
{#              carrito.add(productoId); // Agregar solo IDs únicos#}
{#              localStorage.setItem("carrito", JSON.stringify([...carrito])); // Guardar en localStorage#}
{#              actualizarContadorCarrito(carrito.size);#}
{##}
{#              // Ocultar el modal después de agregar el producto#}
{#              let modal = bootstrap.Modal.getInstance(document.getElementById("numeroMesaModal"));#}
{#              modal.hide();#}
{#          } else {#}
{#              alert("Error al agregar el producto.");#}
{#          }#}
{#      })#}
{#      .catch(error => console.error("Error:", error));#}
{#  }#}
{##}
{#  function actualizarContadorCarrito(totalProductos) {#}
{#      document.getElementById("carrito-contador").innerText = totalProductos;#}
{#  }#}
{##}
{#  // Al cargar la página, obtener el estado actual del carrito desde el servidor#}
{#  window.onload = function() {#}
{#      fetch("/menu/carrito_actual/") // Nueva vista en Django para obtener el carrito actual#}
{#      .then(response => response.json())#}
{#      .then(data => {#}
{#          if (data.productos) {#}
{#              // Fusionar productos del servidor con localStorage#}
{#              data.productos.forEach(id => carrito.add(id));#}
{#              localStorage.setItem("carrito", JSON.stringify([...carrito]));#}
{#              actualizarContadorCarrito(carrito.size);#}
{#          }#}
{#      })#}
{#      .catch(error => console.error("Error al obtener carrito:", error));#}
{#  };#}
{##}
{#  function marcarPedidoEntregado(pedidoId) {#}
{#    fetch(`/menu/pedido/entregado/${pedidoId}/`, {#}
{#        method: 'POST',#}
{#        headers: {#}
{#            'X-CSRFToken': '{{ csrf_token }}'#}
{#        }#}
{#    })#}
{#    .then(response => response.json())#}
{#    .then(data => {#}
{#        if (data.mensaje) {#}
{#            // Al recibir respuesta positiva, reiniciar el carrito#}
{#            carrito.clear();  // Limpiar el carrito#}
{#            localStorage.removeItem('carrito');  // Limpiar localStorage#}
{#            sessionStorage.removeItem('numero_mesa');  // Limpiar sessionStorage#}
{##}
{#            actualizarContadorCarrito(0);  // Reiniciar el contador#}
{##}
{#            alert("Pedido entregado y carrito reiniciado.");#}
{#        }#}
{#    })#}
{#    .catch(error => console.error("Error:", error));#}
{#}  #}
{#</script>#}
{##}
{#{% endblock %}#}
{% extends "base.html" %}
{% load static %}
{% block title %}Menú - FitoMenu{% endblock %}

{% block content %}
<div class="container">
  <div class="row mb-4">
    <div class="col-md-8">
      <h4>Explora nuestro menú</h4>
    </div>
    <div class="col-md-4 text-end">
      {% if not orden_valida %}
        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#ordenModal">
          Ingresar número de orden
        </button>
      {% else %}
{#        <span class="badge bg-success">Orden activa</span>#}
        {% if orden_valida and orden_obj %}
          <span class="badge bg-success">Orden activa: <strong>#{{ orden_obj.orden }}</strong></span>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div class="row">
    {% for producto in productos %}
      <div class="col-md-4 mb-4">
        <div class="card h-100">
          {% if producto.imagen %}
            <img src="{{ producto.imagen.url }}" class="card-img-top" alt="{{ producto.nombre }}">
          {% else %}
            <img src="{% static 'img/default.png' %}" class="card-img-top" alt="Sin imagen">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ producto.nombre }}</h5>
            <p class="card-text">${{ producto.precio }}</p>
            <div class="mt-auto">
              {% if orden_valida %}
                <button class="btn btn-sm btn-primary w-100" onclick="abrirModalAgregar({{ producto.id }}, '{{ producto.nombre }}')">
                    Agregar
                </button>
              {% else %}
                <button class="btn btn-sm btn-secondary w-100" disabled>Debes ingresar tu orden</button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
<div class="modal fade" id="agregarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="agregarForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar <span id="modal-producto-nombre"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="producto_id" id="modal-producto-id">
        <label for="cantidad" class="form-label">Cantidad</label>
        <input type="number" name="cantidad" id="modal-cantidad" class="form-control" min="1" value="1" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Agregar</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast de confirmación -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toast-success" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Producto agregado correctamente.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="ordenModal" tabindex="-1" aria-labelledby="ordenModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content"
      hx-post="{% url 'menu:validar_orden' %}"
      hx-target="#orden-validation-result"
      hx-swap="innerHTML">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="ordenModalLabel">Ingresar número de orden</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="orden-validation-result"></div>
        <label for="ordenInput" class="form-label mt-2">Número de orden</label>
        <input type="number" name="orden_id" class="form-control" id="ordenInput" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Validar</button>
      </div>
    </form>
  </div>
</div>
<script>
  const agregarForm = document.getElementById("agregarForm");
  const agregarModal = document.getElementById("agregarModal");
  const toastSuccess = document.getElementById("toast-success");
  const productoIdInput = document.getElementById("modal-producto-id");
  const productoNombreSpan = document.getElementById("modal-producto-nombre");
  const cantidadInput = document.getElementById("modal-cantidad");

  function abrirModalAgregar(id, nombre) {
    productoIdInput.value = id;
    productoNombreSpan.textContent = nombre;
    cantidadInput.value = 1;
    new bootstrap.Modal(agregarModal).show();
  }

  agregarForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(agregarForm);
    try {
      const response = await fetch("{% url 'menu:agregar_al_pedido' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
        },
        body: formData
      });

      const text = await response.text();
      const data = JSON.parse(text);

      if (data.success) {
        bootstrap.Modal.getInstance(agregarModal).hide();
        new bootstrap.Toast(toastSuccess).show();
      } else {
        showToastError(data.message || "Error al agregar.");
      }
    } catch (err) {
      console.error("Error procesando la respuesta:", err);
      showToastError("Error inesperado en el servidor.");
    }
  });

  function showToastError(message) {
    const errorToast = document.createElement("div");
    errorToast.className = "toast align-items-center text-bg-danger border-0";
    errorToast.role = "alert";
    errorToast.ariaLive = "assertive";
    errorToast.ariaAtomic = "true";
    errorToast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    const container = document.createElement("div");
    container.className = "position-fixed bottom-0 end-0 p-3";
    container.style.zIndex = 9999;
    container.appendChild(errorToast);
    document.body.appendChild(container);

    new bootstrap.Toast(errorToast).show();

    // Eliminar automáticamente después de desaparecer
    errorToast.addEventListener("hidden.bs.toast", () => container.remove());
  }
</script>
{% endblock %}
