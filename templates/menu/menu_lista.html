{% extends "base.html" %}
{% block title %}Menú de Productos - FitoMenu{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    {% for producto in producto %}
    <div class="col-md-4 mb-4">
      <div class="card mx-auto" style="width: 18rem">
        <img src="{{ producto.imagen.url }}" class="card-img-top" alt="{{ producto.nombre }}" />
        <div class="card-body">
          <h5 class="card-title">{{ producto.nombre }}</h5>
          <p class="card-text"><b>${{ producto.precio }}</b></p>
          <button class="btn btn-primary" onclick="setProductoId({{ producto.id }})" data-bs-toggle="modal" data-bs-target="#numeroMesaModal">
            Agregar
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal para ingresar el número de mesa -->
<div class="modal fade" id="numeroMesaModal" tabindex="-1" aria-labelledby="numeroMesaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="numeroMesaLabel">Ingrese detalles del pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="numeroMesaInput">Número de mesa:</label>
        <input type="number" id="numeroMesaInput" class="form-control" placeholder="Número de mesa" min="1">

        <label for="cantidadInput" class="mt-2">Cantidad:</label>
        <input type="number" id="cantidadInput" class="form-control" placeholder="Cantidad" min="1" value="1">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="agregarAlCarrito()">Agregar</button>
      </div>
    </div>
  </div>
</div>

<!-- Contador del carrito (opcional) -->
<div id="carrito-contador" style="position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 5px 10px; border-radius: 50%;">
  0
</div>

<script>
  let productoId = null;

  function setProductoId(id) {
      productoId = id;
  }

  function agregarAlCarrito() {
      let numeroMesa = document.getElementById("numeroMesaInput").value;
      let cantidad = document.getElementById("cantidadInput").value;

      if (!numeroMesa || !cantidad || cantidad <= 0) {
          alert("Por favor, ingrese un número de mesa y una cantidad válida.");
          return;
      }

      fetch(`/menu/carrito/${productoId}/${numeroMesa}/${cantidad}/`, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert("Producto agregado al carrito.");
              actualizarContadorCarrito(data.total_items);
              
              // Ocultar el modal después de agregar el producto
              let modal = bootstrap.Modal.getInstance(document.getElementById("numeroMesaModal"));
              modal.hide();
          } else {
              alert("Error al agregar el producto.");
          }
      })
      .catch(error => console.error("Error:", error));
  }

  function actualizarContadorCarrito(total) {
      document.getElementById("carrito-contador").innerText = total;
  }
</script>

{% endblock %}
